name: Engine

on:
  push:
    branches: ["**"]
    paths:
      - "core-engine/**"
      - "services/**"
      - "config/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "rust-toolchain.toml"
      - ".github/workflows/engine.yml"
  pull_request:
    branches: ["**"]
    paths:
      - "core-engine/**"
      - "services/**"
      - "config/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "rust-toolchain.toml"
      - ".github/workflows/engine.yml"
  workflow_dispatch:

concurrency:
  group: engine-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-Dwarnings"
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.12"
  SOLANA_VERSION: "v1.18.26"
  # Optional: match your repo's minimum supported Rust version policy
  # MSRV: "1.78.0"

jobs:
  rust-core:
    name: Rust core-engine (fmt, clippy, test)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OS deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential pkg-config libssl-dev libudev-dev \
            curl ca-certificates git jq
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target

      - name: Cargo fmt (check)
        run: |
          set -euo pipefail
          cargo fmt --all --check

      - name: Cargo clippy (deny warnings)
        run: |
          set -euo pipefail
          cargo clippy --workspace --all-targets --all-features

      - name: Cargo tests (workspace)
        run: |
          set -euo pipefail
          cargo test --workspace --all-features

      - name: Cargo doc (no deps)
        run: |
          set -euo pipefail
          cargo doc --workspace --no-deps

  integration-localnet:
    name: Engine integration (local Solana + smoke)
    runs-on: ubuntu-latest
    needs: rust-core
    defaults:
      run:
        shell: bash
    env:
      SOLANA_URL: "http://127.0.0.1:8899"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OS deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential pkg-config libssl-dev libudev-dev \
            curl ca-certificates git jq unzip
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target

      - name: Install Solana CLI
        run: |
          set -euo pipefail
          echo "Installing Solana $SOLANA_VERSION"
          sh -c "$(curl -sSfL https://release.solana.com/${SOLANA_VERSION}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> "$GITHUB_PATH"
          solana --version

      - name: Configure Solana URL
        run: |
          set -euo pipefail
          solana config set --url "$SOLANA_URL"
          solana config get

      - name: Prepare wallet
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.config/solana"
          solana-keygen new --no-bip39-passphrase -o "$HOME/.config/solana/id.json" --force
          echo "SOLANA_WALLET=$HOME/.config/solana/id.json" >> "$GITHUB_ENV"
          echo "SOLANA_URL=$SOLANA_URL" >> "$GITHUB_ENV"
          solana address

      - name: Start local validator
        run: |
          set -euo pipefail
          solana-test-validator --reset --quiet --limit-ledger-size &
          echo $! > /tmp/validator.pid

          for i in $(seq 1 60); do
            if solana cluster-version >/dev/null 2>&1; then
              echo "Validator is up"
              break
            fi
            sleep 1
          done

      - name: Airdrop
        run: |
          set -euo pipefail
          solana airdrop 10 || solana airdrop 10
          solana balance

      - name: Build engine binaries
        run: |
          set -euo pipefail
          # Build only engine-related bins if present; fall back to workspace build.
          if cargo metadata --no-deps --format-version 1 | jq -e '.packages[] | select(.name=="m0d")' >/dev/null 2>&1; then
            cargo build -p m0d --release
          else
            cargo build --workspace --release
          fi

      - name: Smoke run (daemon help)
        run: |
          set -euo pipefail
          # Try to run a help command for the engine daemon if it exists.
          if [ -f "target/release/m0d" ]; then
            ./target/release/m0d --help >/dev/null
            echo "m0d help OK"
          else
            echo "No m0d binary found. Ensure core-engine/bin/m0d exists or adjust workflow."
          fi

      - name: Smoke run (ingestor help)
        run: |
          set -euo pipefail
          if [ -f "target/release/m0-ingestd" ]; then
            ./target/release/m0-ingestd --help >/dev/null
            echo "m0-ingestd help OK"
          else
            echo "No m0-ingestd binary found. Skipping."
          fi

      - name: Stop local validator
        if: always()
        run: |
          set -euo pipefail
          if [ -f /tmp/validator.pid ]; then
            kill "$(cat /tmp/validator.pid)" || true
          fi

  artifacts:
    name: Publish build artifacts (optional)
    runs-on: ubuntu-latest
    needs: [rust-core]
    if: ${{ github.event_name == 'workflow_dispatch' }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target

      - name: Build release
        run: |
          set -euo pipefail
          cargo build --workspace --release

      - name: Collect binaries
        run: |
          set -euo pipefail
          mkdir -p artifacts/bin
          for b in m0d m0-ingestd m0-backtestd m0-signer-agent; do
            if [ -f "target/release/$b" ]; then
              cp "target/release/$b" artifacts/bin/
            fi
          done
          ls -la artifacts/bin || true

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: engine-binaries
          path: artifacts/bin
          if-no-files-found: ignore
          retention-days: 14

  security:
    name: Dependency security (OSV)
    runs-on: ubuntu-latest
    needs: rust-core
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: OSV-Scanner
        uses: google/osv-scanner-action@v1.7.3
        with:
          scan-args: |-
            --recursive
            --skip-git
            .

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: osv-results.sarif
          category: osv
